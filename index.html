<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PR√â-NATAL DRA SCHWARTZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --rosa1: #ec407a;
      --rosa2: #d81b60;
      --rosa3: #f48fb1;
      --rosa-claro: #ffe4ef;
      --bg: #fff7fb;
      --texto: #333;

      --risk-baixo: #e8f5e9;
      --risk-inter: #fff8e1;
      --risk-alto: #ffebee;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--texto);
    }

    header {
      background: linear-gradient(135deg, var(--rosa1), var(--rosa2));
      color: white;
      text-align: center;
      padding: 22px 12px 18px;
      border-bottom-left-radius: 22px;
      border-bottom-right-radius: 22px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 800;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .gestante-icon { font-size: 30px; }

    .subtitle {
      font-size: 14px;
      margin-top: 6px;
      opacity: 0.95;
    }

    .chips { margin-top: 8px; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.22);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin: 2px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto 40px;
      padding: 16px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 18px;
      border: 1px solid var(--rosa3);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #880e4f;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    label {
      font-weight: 600;
      font-size: 13px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 3px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    .col-2 { flex: 0 0 calc(16.66% - 8px); }
    .col-3 { flex: 0 0 calc(25% - 8px); }
    .col-4 { flex: 0 0 calc(33.33% - 8px); }
    .col-6 { flex: 0 0 calc(50% - 8px); }
    .col-12 { flex: 0 0 100%; }

    @media (max-width: 900px) {
      .col-2, .col-3, .col-4, .col-6 { flex: 0 0 100%; }
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 9px 12px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-primary {
      background: var(--rosa1);
      color: white;
      width: 100%;
    }
    .btn-primary:hover { background: var(--rosa2); }

    .btn-outline {
      background: white;
      color: var(--rosa2);
      border: 1px solid var(--rosa2);
    }
    .btn-outline:hover { background: var(--rosa-claro); }

    .btn-small {
      font-size: 11px;
      padding: 4px 8px;
      margin: 1px;
    }

    .small {
      font-size: 11px;
      color: #616161;
    }

    .table-wrapper {
      border-radius: 10px;
      border: 1px solid #f3c5dd;
      max-height: 430px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }

    th {
      position: sticky;
      top: 0;
      background: var(--rosa-claro);
      z-index: 1;
      font-size: 12px;
    }

    .row-baixo { background: var(--risk-baixo); border-left: 4px solid #2e7d32; }
    .row-intermediario { background: var(--risk-inter); border-left: 4px solid #ffa000; }
    .row-alto { background: var(--risk-alto); border-left: 4px solid #c62828; }

    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      margin: 1px 0;
    }

    .badge-ok { background: #e8f5e9; color: #2e7d32; }
    .badge-warn { background: #fff8e1; color: #f57f17; }
    .badge-neutral { background: #eceff1; color: #455a64; }

    .pill-risk {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
    }

    .pill-risk.baixo { border: 1px solid #2e7d32; color: #2e7d32; }
    .pill-risk.intermediario { border: 1px solid #ffa000; color: #e65100; }
    .pill-risk.alto { border: 1px solid #c62828; color: #b71c1c; }

    .filter-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn-filter-active {
      background: var(--rosa2);
      color: #fff;
    }

    /* ===== Tela de Login Firebase ‚Äì Pr√©-natal ===== */
    #login-container {
      max-width: 380px;
      margin: 40px auto;
      padding: 24px 20px 28px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      border: 1px solid #f8bbd0;
    }
    #login-container h2 {
      margin-top: 0;
      margin-bottom: 4px;
      text-align: center;
      color: var(--rosa2);
      font-size: 1.3rem;
    }
    #login-container p.subtitle {
      margin: 0 0 16px;
      text-align: center;
      font-size: 0.9rem;
      color: #666;
    }
    #login-container label {
      font-size: 0.85rem;
      display: block;
      margin-top: 10px;
      margin-bottom: 2px;
      color: #555;
      font-weight: 600;
    }
    #login-container input[type="email"],
    #login-container input[type="password"] {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #fafafa;
      font-family: inherit;
    }
    #login-container input[type="email"]:focus,
    #login-container input[type="password"]:focus {
      border-color: var(--rosa2);
      box-shadow: 0 0 0 2px rgba(216,27,96,0.18);
      background: white;
    }
    #login-submit {
      width: 100%;
      padding: 11px;
      margin-top: 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(135deg, var(--rosa2), var(--rosa1));
      color: white;
      box-shadow: 0 4px 12px rgba(216,27,96,0.45);
      cursor: pointer;
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
    }
    #login-submit:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 6px 16px rgba(216,27,96,0.55);
    }
    #login-submit:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(216,27,96,0.4);
    }
    #login-error {
      color: #d32f2f;
      text-align: center;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    .app-auth-hidden {
      display: none !important;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg0HPhWoqbEhjybTYDfBg1AQbCbbIquaE",
      authDomain: "gerenciador-draschwartz.firebaseapp.com",
      projectId: "gerenciador-draschwartz",
      storageBucket: "gerenciador-draschwartz.firebasestorage.app",
      messagingSenderId: "283430261434",
      appId: "1:283430261434:web:4c2681d93f99c3c1382883",
      measurementId: "G-R7TE29MLKB"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);

    window._auth = auth;
    window._authFns = { onAuthStateChanged, signInWithEmailAndPassword, signOut };
  </script>
</head>

<body>

<div id="login-container">
  <h2>Login ‚Äì Pr√©-natal</h2>
  <p class="subtitle">Acesse com o e-mail cadastrado pela Dra. Schwartz</p>

  <form id="login-form">
    <label for="login-email">E-mail</label>
    <input type="email" id="login-email" autocomplete="email" required>

    <label for="login-password">Senha</label>
    <input type="password" id="login-password" autocomplete="current-password" required>

    <button id="login-submit" type="submit">Entrar</button>
  </form>

  <p id="login-error" style="display:none;"></p>
</div>

<header class="app-auth-hidden">
  <h1>
    <span class="gestante-icon">ü§∞</span>
    PR√â-NATAL DRA SCHWARTZ
  </h1>
  <div class="subtitle">
    Painel de gestantes com risco, exames e consultas conforme protocolo.
  </div>
  <div class="chips">
    <span class="chip">üü¢ Habitual</span>
    <span class="chip">üü° Interm.</span>
    <span class="chip">üî¥ Alto risco</span>
    <span class="chip">üìÖ IG pela US / DUM</span>
  </div>
</header>

<div class="container app-auth-hidden">

  <!-- FORMUL√ÅRIO -->
  <div class="card">
    <h2>ü§∞ Cadastrar / Editar Gestante</h2>

    <form id="form-gestante">
      <input type="hidden" id="id">

      <div class="row">
        <div class="col-6">
          <label>Nome completo</label>
          <input id="nome" required>
        </div>

        <div class="col-3">
          <label>Data de nascimento</label>
          <input id="dataNasc" type="date">
        </div>

        <div class="col-3">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="60">
        </div>

        <div class="col-4">
          <label>UBS</label>
          <input id="ubs" placeholder="Ex.: UBS Santu√°rio">
        </div>

        <div class="col-4">
          <label>Micro√°rea</label>
          <input id="microarea">
        </div>

        <div class="col-4">
          <label>ACS</label>
          <input id="acs">
        </div>

        <div class="col-3">
          <label>Classifica√ß√£o de risco</label>
          <select id="risco">
            <option value="">Selecione</option>
            <option value="baixo">Risco habitual</option>
            <option value="intermediario">Risco intermedi√°rio</option>
            <option value="alto">Alto risco</option>
          </select>
        </div>

        <div class="col-3">
          <label>DUM</label>
          <input id="dum" type="date">
        </div>

        <div class="col-3">
          <label>Data da 1¬™ US</label>
          <input id="usData" type="date">
        </div>

        <div class="col-2">
          <label>IG na US (sem)</label>
          <input id="usSemanas" type="number" min="0" max="42">
        </div>

        <div class="col-2">
          <label>IG na US (dias)</label>
          <input id="usDias" type="number" min="0" max="6">
        </div>

        <div class="col-3">
          <label>√öltima consulta</label>
          <input id="consultaUltima" type="date">
        </div>

        <div class="col-3">
          <label>Pr√≥xima consulta (pode ajustar)</label>
          <input id="consultaProxima" type="date">
        </div>

        <div class="col-3">
          <label>DPP (calculada)</label>
          <input id="dpp" type="date" readonly>
        </div>

        <div class="col-3">
          <label>Swab vaginal / retal</label>
          <select id="swab">
            <option value="">N√£o solicitado</option>
            <option value="solicitado">Solicitado</option>
            <option value="realizado">Realizado</option>
          </select>
        </div>

        <div class="col-3">
          <label>Exames 1¬∫ tri</label>
          <select id="ex1">
            <option value="">N√£o solicitado</option>
            <option value="solicitado">Solicitado</option>
            <option value="realizado">Realizado</option>
          </select>
        </div>

        <div class="col-3">
          <label>Exames 2¬∫ tri / TTOG</label>
          <select id="ex2">
            <option value="">N√£o solicitado</option>
            <option value="solicitado">Solicitado</option>
            <option value="realizado">Realizado</option>
          </select>
        </div>

        <div class="col-3">
          <label>Exames 3¬∫ tri</label>
          <select id="ex3">
            <option value="">N√£o solicitado</option>
            <option value="solicitado">Solicitado</option>
            <option value="realizado">Realizado</option>
          </select>
        </div>

        <div class="col-3">
          <label>Vacinas</label>
          <select id="vacinas">
            <option value="">N√£o informado</option>
            <option value="ok">OK / em dia</option>
            <option value="pendente">Pendente</option>
          </select>
        </div>

        <div class="col-3">
          <label>Odonto</label>
          <select id="odonto">
            <option value="">N√£o informado</option>
            <option value="ok">Avaliada / tratada</option>
            <option value="pendente">Pendente</option>
          </select>
        </div>

        <div class="col-6">
          <label>Condi√ß√µes de sa√∫de / comorbidades</label>
          <textarea id="condicoes" placeholder="Ex.: HAS, DM2, cardiopatia, uso de medica√ß√£o cont√≠nua..."></textarea>
        </div>

        <div class="col-6">
          <label>Alergias</label>
          <textarea id="alergias" placeholder="Ex.: alergia a penicilina, dipirona, alimentos..."></textarea>
        </div>

        <div class="col-12">
          <label>Justificativa da estratifica√ß√£o de risco</label>
          <textarea id="justificativa" placeholder="Ex.: HAS cr√¥nica, DMG pr√©via, idade ‚â• 35 anos, ces√°reas pr√©vias, etc."></textarea>
        </div>

        <!-- NOVA SE√á√ÉO: TESTES R√ÅPIDOS -->
        <div class="col-12">
          <hr style="margin:12px 0;">
          <h3 style="margin:0 0 6px; font-size:15px; color:#880e4f;">
            üß™ Testes r√°pidos ‚Äì sorologias
          </h3>
        </div>

        <div class="col-6">
          <label>HIV ‚Äì teste r√°pido</label>
          <select id="hivStatus">
            <option value="">N√£o realizado / n√£o informado</option>
            <option value="nao-reagente">N√£o reagente</option>
            <option value="reagente">Reagente</option>
          </select>
          <input id="hivObs" placeholder="Se reagente, especificar (ex.: teste r√°pido reagente, aguardando confirma√ß√£o)">
        </div>

        <div class="col-6">
          <label>S√≠filis ‚Äì teste r√°pido / VDRL</label>
          <select id="sifilisStatus">
            <option value="">N√£o realizado / n√£o informado</option>
            <option value="nao-reagente">N√£o reagente</option>
            <option value="reagente">Reagente</option>
          </select>
          <input id="sifilisObs" placeholder="Se reagente, especificar (ex.: VDRL 1:8 + TPHA reagente)">
        </div>

        <div class="col-6">
          <label>Hepatite B (HBsAg)</label>
          <select id="hbvStatus">
            <option value="">N√£o realizado / n√£o informado</option>
            <option value="nao-reagente">N√£o reagente</option>
            <option value="reagente">Reagente</option>
          </select>
          <input id="hbvObs" placeholder="Se reagente, especificar (ex.: HBsAg reagente)">
        </div>

        <div class="col-6">
          <label>Hepatite C (Anti-HCV)</label>
          <select id="hcvStatus">
            <option value="">N√£o realizado / n√£o informado</option>
            <option value="nao-reagente">N√£o reagente</option>
            <option value="reagente">Reagente</option>
          </select>
          <input id="hcvObs" placeholder="Se reagente, especificar (ex.: Anti-HCV reagente)">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col-6">
          <button type="submit" class="btn-primary">üíæ Salvar gestante</button>
        </div>
        <div class="col-6">
          <button type="button" class="btn-outline" onclick="limparFormulario()">üßπ Limpar formul√°rio</button>
        </div>
      </div>

      <div class="small" style="margin-top:6px;">
        IG √© calculada priorizando a 1¬™ US (semanas + dias na data do exame).  
        Na aus√™ncia de US informada, utiliza a DUM para estimativa.
      </div>
    </form>
  </div>

  <!-- LISTA / PAINEL -->
  <div class="card">
    <div class="row" style="align-items:center; margin-bottom:8px;">
      <div class="col-6">
        <h2>üìã Gestantes cadastradas</h2>
      </div>
      <div class="col-6" style="text-align:right;">
        <div class="filter-buttons">
          <button type="button" class="btn-outline btn-small" id="f-todas" onclick="setFiltro('todas')">üëÄ Todas</button>
          <button type="button" class="btn-outline btn-small" id="f-atraso" onclick="setFiltro('atraso')">‚è∞ Em atraso</button>
          <button type="button" class="btn-outline btn-small" id="f-risco" onclick="setFiltro('risco')">‚ö†Ô∏è Interm./Alto risco</button>
          <button class="btn-outline btn-small" onclick="exportarCSV()">üì§ CSV</button>
          <button class="btn-outline btn-small" onclick="exportarPDFGeral()">üìÑ PDF geral</button>
        </div>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Gestante / UBS</th>
            <th>IG hoje / DPP</th>
            <th>Risco</th>
            <th>Exames / Swab / Vacinas / Odonto / Testes r√°pidos</th>
            <th>Consultas</th>
            <th>Alertas (exames + janelas)</th>
            <th>Condi√ß√µes / Alergias / Justificativa</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabela-gestantes"></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:6px;">
      Lista ordenada por: consulta atrasada ‚ü∂ maior risco ‚ü∂ maior IG.  
      Alertas por janelas: 1¬∫ tri, US morfol√≥gica 20‚Äì26s, TTOG/2¬∫ tri 24‚Äì28s, exames 3¬∫ tri 32‚Äì36s, US 34‚Äì37s, swab 35‚Äì37s.
    </div>
  </div>

  <!-- BACKUP -->
  <div class="card">
    <h2>üì¶ Backup</h2>
    <div class="small">
      Para usar em outro aparelho, exporte o backup em JSON neste dispositivo
      e depois importe no outro aparelho usando o mesmo app.
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="col-6">
        <button class="btn-outline" type="button" onclick="exportarBackupJSON()">üì§ Exportar backup (.json)</button>
      </div>
      <div class="col-6">
        <input type="file" id="inputBackup" accept=".json" style="display:none" onchange="importarBackupJSON(event)">
        <button class="btn-outline" type="button" onclick="document.getElementById('inputBackup').click()">üì• Importar backup (.json)</button>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "prenatal_dra_schwartz_v6";
  let filtroAtual = "todas";

  function carregarGestantes() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch(e) { console.error(e); return []; }
  }

  function salvarGestantes(lista) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
  }

  function calcularIdade(dataNascStr) {
    if (!dataNascStr) return "";
    const d = new Date(dataNascStr);
    if (isNaN(d)) return "";
    const hoje = new Date();
    let idade = hoje.getFullYear() - d.getFullYear();
    const m = hoje.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && hoje.getDate() < d.getDate())) idade--;
    return idade;
  }

  // === IG CORRIGIDA (US / DUM) ===
  function calcularIG(dum, usData, usSemanas, usDias) {
    const hoje = new Date();
    hoje.setHours(0,0,0,0);

    // Prioriza 1¬™ US
    if (usData && usSemanas !== "" && usSemanas != null) {
      const ref = new Date(usData + "T00:00:00");
      if (isNaN(ref)) return null;
      const w = parseInt(usSemanas || "0", 10);
      const d = parseInt(usDias || "0", 10);
      if (isNaN(w) || isNaN(d)) return null;

      const diffDias = Math.round((hoje - ref) / 86400000); // corrige fuso/hor√°rio
      const total = w * 7 + d + diffDias;
      if (total < 0) return null;

      return { semanas: Math.floor(total / 7), dias: total % 7, total, metodo: "US" };
    }

    // Sem US ‚Üí usa DUM
    if (dum) {
      const ref = new Date(dum + "T00:00:00");
      if (isNaN(ref)) return null;
      const diffDias = Math.round((hoje - ref) / 86400000);
      if (diffDias < 0) return null;

      return { semanas: Math.floor(diffDias / 7), dias: diffDias % 7, total: diffDias, metodo: "DUM" };
    }
    return null;
  }

  // === DPP corrigida, alinhada com a IG ===
  function estimarDPP(dum, usData, usSemanas, usDias) {
    let base = null;

    if (dum) {
      base = new Date(dum + "T00:00:00");
    } else if (usData && usSemanas !== "" && usSemanas != null) {
      const ref = new Date(usData + "T00:00:00");
      const w = parseInt(usSemanas || "0", 10);
      const d = parseInt(usDias || "0", 10);
      if (!isNaN(ref) && !isNaN(w) && !isNaN(d)) {
        const diasIG = w * 7 + d;
        base = new Date(ref.getTime() - diasIG * 86400000);
      }
    }

    if (!base || isNaN(base)) return "";
    const dpp = new Date(base.getTime() + 280 * 86400000);
    return dpp.toISOString().slice(0,10);
  }

  function sugerirProximaConsulta(ig, risco, consultaUltimaStr) {
    if (!ig) return "";
    let diasIntervalo;
    if (risco === "alto") {
      if (ig.semanas < 28) diasIntervalo = 21;
      else if (ig.semanas < 36) diasIntervalo = 10;
      else diasIntervalo = 7;
    } else if (risco === "intermediario") {
      if (ig.semanas < 28) diasIntervalo = 30;
      else if (ig.semanas < 36) diasIntervalo = 14;
      else diasIntervalo = 7;
    } else {
      if (ig.semanas < 28) diasIntervalo = 30;
      else if (ig.semanas < 36) diasIntervalo = 21;
      else diasIntervalo = 7;
    }

    let base = new Date();
    if (consultaUltimaStr) {
      const c = new Date(consultaUltimaStr);
      if (!isNaN(c)) base = c;
    }
    const prox = new Date(base.getTime() + diasIntervalo * 86400000);
    return prox.toISOString().slice(0,10);
  }

  function badgeExame(status, label) {
    if (!status) return `<span class="badge badge-neutral">${label}: n√£o solicitado</span>`;
    if (status === "realizado") return `<span class="badge badge-ok">${label}: realizado</span>`;
    if (status === "solicitado") return `<span class="badge badge-warn">${label}: solicitado</span>`;
    return `<span class="badge badge-neutral">${label}: n√£o informado</span>`;
  }

  function badgeOkPend(status, okText, pendText) {
    if (!status) return `<span class="badge badge-neutral">${pendText}</span>`;
    if (status === "ok") return `<span class="badge badge-ok">${okText}</span>`;
    if (status === "pendente") return `<span class="badge badge-warn">${pendText}</span>`;
    return `<span class="badge badge-neutral">${pendText}</span>`;
  }

  function badgeTesteRapido(status, label, obs) {
    if (!status) {
      return `<span class="badge badge-neutral">${label}: n√£o realizado / n√£o informado</span>`;
    }
    if (status === "nao-reagente") {
      return `<span class="badge badge-ok">${label}: n√£o reagente</span>`;
    }
    if (status === "reagente") {
      const det = obs ? " ‚Äì " + obs.replace(/\n/g,"<br>") : "";
      return `<span class="badge badge-warn">${label}: reagente${det}</span>`;
    }
    return `<span class="badge badge-neutral">${label}: n√£o informado</span>`;
  }

  function gerarAlertasExames(ig, ex1, ex2, ex3, swab) {
    if (!ig) return "";
    const w = ig.semanas;
    const msgs = [];

    if (w <= 13 && ex1 !== "realizado") {
      msgs.push("Garantir exames de 1¬∫ tri (sorologias, uro, hemograma, etc.).");
    }
    if (w >= 20 && w <= 26) {
      msgs.push("Verificar/solicitar US morfol√≥gica 20‚Äì26s.");
    }
    if (w >= 24 && w <= 28 && ex2 !== "realizado") {
      msgs.push("Solicitar TTOG 75 g + exames de 2¬∫ tri (24‚Äì28s).");
    }
    if (w >= 32 && w <= 36 && ex3 !== "realizado") {
      msgs.push("Solicitar exames de 3¬∫ tri (hemograma, urina, sorologias).");
    }
    if (w >= 34 && w <= 37) {
      msgs.push("Programar/confirmar US 34‚Äì37s.");
    }
    if (w >= 35 && w <= 37 && swab !== "realizado") {
      msgs.push("Lembrar swab vaginal/retal (35‚Äì37s), conforme protocolo.");
    }

    if (!msgs.length) return '<span class="small">Sem alerta espec√≠fico nesta IG.</span>';
    return "‚Ä¢ " + msgs.join("<br>‚Ä¢ ");
  }

  function limparFormulario() {
    document.getElementById("form-gestante").reset();
    document.getElementById("id").value = "";
    document.getElementById("dpp").value = "";
  }

  function preencherFormulario(g) {
    document.getElementById("id").value = g.id;
    document.getElementById("nome").value = g.nome || "";
    document.getElementById("dataNasc").value = g.dataNasc || "";
    document.getElementById("idade").value = g.idade || "";
    document.getElementById("ubs").value = g.ubs || "";
    document.getElementById("microarea").value = g.microarea || "";
    document.getElementById("acs").value = g.acs || "";
    document.getElementById("risco").value = g.risco || "";
    document.getElementById("dum").value = g.dum || "";
    document.getElementById("usData").value = g.usData || "";
    document.getElementById("usSemanas").value = g.usSemanas ?? "";
    document.getElementById("usDias").value = g.usDias ?? "";
    document.getElementById("consultaUltima").value = g.consultaUltima || "";
    document.getElementById("consultaProxima").value = g.consultaProxima || "";
    document.getElementById("dpp").value = g.dpp || "";
    document.getElementById("swab").value = g.swab || "";
    document.getElementById("ex1").value = g.ex1 || "";
    document.getElementById("ex2").value = g.ex2 || "";
    document.getElementById("ex3").value = g.ex3 || "";
    document.getElementById("vacinas").value = g.vacinas || "";
    document.getElementById("odonto").value = g.odonto || "";
    document.getElementById("condicoes").value = g.condicoes || "";
    document.getElementById("alergias").value = g.alergias || "";
    document.getElementById("justificativa").value = g.justificativa || "";

    document.getElementById("hivStatus").value = g.hivStatus || "";
    document.getElementById("hivObs").value = g.hivObs || "";
    document.getElementById("sifilisStatus").value = g.sifilisStatus || "";
    document.getElementById("sifilisObs").value = g.sifilisObs || "";
    document.getElementById("hbvStatus").value = g.hbvStatus || "";
    document.getElementById("hbvObs").value = g.hbvObs || "";
    document.getElementById("hcvStatus").value = g.hcvStatus || "";
    document.getElementById("hcvObs").value = g.hcvObs || "";

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function removerGestante(id) {
    if (!confirm("Remover esta gestante da lista?")) return;
    const lista = carregarGestantes().filter(g => g.id !== id);
    salvarGestantes(lista);
    renderizarTabela();
  }

  function abrirResumoPDF(id) {
    const lista = carregarGestantes();
    const g = lista.find(x => x.id === id);
    if (!g) return;

    const ig = calcularIG(g.dum, g.usData, g.usSemanas, g.usDias);
    const dpp = estimarDPP(g.dum, g.usData, g.usSemanas, g.usDias);
    const igTexto = ig ? `${ig.semanas}s ${ig.dias}d (${ig.metodo})` : "‚Äî";
    const idadeCalc = g.dataNasc ? calcularIdade(g.dataNasc) : "";

    function resumoTestesInd(gest) {
      const partes = [];
      function add(label, status, obs) {
        if (!status) return;
        if (status === "nao-reagente") partes.push(`${label}: n√£o reagente`);
        else if (status === "reagente") {
          let t = `${label}: reagente`;
          if (obs) t += " (" + obs.replace(/[\r\n]+/g," ") + ")";
          partes.push(t);
        }
      }
      add("HIV", gest.hivStatus, gest.hivObs);
      add("S√≠filis", gest.sifilisStatus, gest.sifilisObs);
      add("Hepatite B", gest.hbvStatus, gest.hbvObs);
      add("Hepatite C", gest.hcvStatus, gest.hcvObs);
      if (!partes.length) return "N√£o realizado / n√£o informado.";
      return partes.join("<br>");
    }

    const testesHtml = resumoTestesInd(g);

    const win = window.open("", "_blank");
    const html = `
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Pr√©-natal ‚Äì ${g.nome}</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; padding: 20px; }
          h1 { font-size: 20px; margin-bottom: 4px; }
          h2 { font-size: 16px; margin-top: 16px; }
          table { width: 100%; border-collapse: collapse; font-size: 13px; }
          td { padding: 4px; border-bottom: 1px solid #ddd; vertical-align: top; }
          .label { font-weight: 600; width: 160px; }
        </style>
      </head>
      <body>
        <h1>Pr√©-natal ‚Äì Dra. Schwartz</h1>
        <div>Resumo individual da gestante</div>

        <h2>1. Identifica√ß√£o</h2>
        <table>
          <tr><td class="label">Nome</td><td>${g.nome || ""}</td></tr>
          <tr><td class="label">Data de nascimento</td><td>${g.dataNasc || ""} ${idadeCalc ? " ("+idadeCalc+" anos)" : ""}</td></tr>
          <tr><td class="label">Idade (campo)</td><td>${g.idade || ""}</td></tr>
          <tr><td class="label">UBS / Micro√°rea</td><td>${g.ubs || ""} ${g.microarea ? " ¬∑ Micro√°rea " + g.microarea : ""}</td></tr>
          <tr><td class="label">ACS</td><td>${g.acs || ""}</td></tr>
        </table>

        <h2>2. Gesta√ß√£o</h2>
        <table>
          <tr><td class="label">Risco</td><td>${g.risco || ""}</td></tr>
          <tr><td class="label">DUM</td><td>${g.dum || ""}</td></tr>
          <tr><td class="label">1¬™ US</td><td>${g.usData || ""} ${g.usSemanas ? " (" + g.usSemanas + "s" + (g.usDias ? " " + g.usDias + "d" : "") + ")" : ""}</td></tr>
          <tr><td class="label">IG hoje</td><td>${igTexto}</td></tr>
          <tr><td class="label">DPP</td><td>${dpp || ""}</td></tr>
        </table>

        <h2>3. Consultas</h2>
        <table>
          <tr><td class="label">√öltima consulta</td><td>${g.consultaUltima || ""}</td></tr>
          <tr><td class="label">Pr√≥xima consulta</td><td>${g.consultaProxima || ""}</td></tr>
        </table>

        <h2>4. Exames, vacinas, odonto e testes r√°pidos</h2>
        <table>
          <tr><td class="label">Exames 1¬∫ tri</td><td>${g.ex1 || ""}</td></tr>
          <tr><td class="label">Exames 2¬∫ tri / TTOG</td><td>${g.ex2 || ""}</td></tr>
          <tr><td class="label">Exames 3¬∫ tri</td><td>${g.ex3 || ""}</td></tr>
          <tr><td class="label">Swab</td><td>${g.swab || ""}</td></tr>
          <tr><td class="label">Vacinas</td><td>${g.vacinas || ""}</td></tr>
          <tr><td class="label">Odonto</td><td>${g.odonto || ""}</td></tr>
          <tr><td class="label">Testes r√°pidos</td><td>${testesHtml}</td></tr>
        </table>

        <h2>5. Condi√ß√µes de sa√∫de e alergias</h2>
        <table>
          <tr><td class="label">Condi√ß√µes</td><td>${(g.condicoes || "").replace(/\\n/g,"<br>")}</td></tr>
          <tr><td class="label">Alergias</td><td>${(g.alergias || "").replace(/\\n/g,"<br>")}</td></tr>
        </table>

        <h2>6. Justificativa do risco</h2>
        <div>${(g.justificativa || "").replace(/\\n/g,"<br>")}</div>

        <p style="margin-top:18px; font-size:12px; color:#777;">
          Gerado automaticamente no app PR√â-NATAL DRA SCHWARTZ.
        </p>
        <p style="margin-top:4px; font-size:12px; color:#777;">
          Desenvolvido por Dra. Fernanda Schwartz.
        </p>
      </body>
      </html>
    `;
    win.document.write(html);
    win.document.close();
  }

  // === Relat√≥rio geral em p√°gina √∫nica, com IG atualizada e estratifica√ß√£o por risco ===
  function resumoTestesGeral(g) {
    const partes = [];
    function add(label, status, obs) {
      if (!status) return;
      if (status === "nao-reagente") partes.push(`${label}: n√£o reagente`);
      else if (status === "reagente") {
        let t = `${label}: reagente`;
        if (obs) t += " (" + obs.replace(/[\r\n]+/g," ") + ")";
        partes.push(t);
      }
    }
    add("HIV", g.hivStatus, g.hivObs);
    add("S√≠filis", g.sifilisStatus, g.sifilisObs);
    add("Hep. B", g.hbvStatus, g.hbvObs);
    add("Hep. C", g.hcvStatus, g.hcvObs);
    if (!partes.length) return "";
    return "Testes r√°pidos: " + partes.join("; ");
  }

  function exportarPDFGeral() {
    const lista = carregarGestantes();
    if (!lista || !lista.length) {
      alert("Nenhuma gestante cadastrada para gerar o relat√≥rio.");
      return;
    }

    // Monta grupos por risco
    const grupos = {
      alto: [],
      intermediario: [],
      habitual: [],
      outro: []
    };

    lista.forEach(g => {
      if (!g) return;
      const ig = calcularIG(g.dum, g.usData, g.usSemanas, g.usDias);
      const dpp = estimarDPP(g.dum, g.usData, g.usSemanas, g.usDias);
      const risco = (g.risco || "").toLowerCase();

      const item = {
        nome: g.nome || "",
        ubs: g.ubs || "",
        microarea: g.microarea || "",
        acs: g.acs || "",
        risco: risco || "n√£o informado",
        igTexto: ig ? (ig.semanas + "s " + ig.dias + "d (" + ig.metodo + ")") : "‚Äî",
        dpp: dpp || "‚Äî",
        dum: g.dum || "",
        usData: g.usData || "",
        usSemanas: g.usSemanas || "",
        usDias: g.usDias || "",
        consultaUltima: g.consultaUltima || "",
        consultaProxima: g.consultaProxima || "",
        vacinas: g.vacinas || "",
        odonto: g.odonto || "",
        examesResumo: g.examesResumo || "",
        condicoes: g.condicoes || "",
        alergias: g.alergias || "",
        hivStatus: g.hivStatus || "",
        hivObs: g.hivObs || "",
        sifilisStatus: g.sifilisStatus || "",
        sifilisObs: g.sifilisObs || "",
        hbvStatus: g.hbvStatus || "",
        hbvObs: g.hbvObs || "",
        hcvStatus: g.hcvStatus || "",
        hcvObs: g.hcvObs || ""
      };

      if (risco === "alto") grupos.alto.push(item);
      else if (risco === "intermediario" || risco === "intermedi√°ria") grupos.intermediario.push(item);
      else if (risco === "baixo" || risco === "habitual") grupos.habitual.push(item);
      else grupos.outro.push(item);
    });

    // Ordena dentro de cada grupo por IG total (se dispon√≠vel)
    function totalDias(igTexto) {
      // Ex.: "32s 4d (US)"
      if (!igTexto || igTexto === "‚Äî") return -1;
      const m = igTexto.match(/(\d+)s\s+(\d+)d/);
      if (!m) return -1;
      const s = parseInt(m[1], 10) || 0;
      const d = parseInt(m[2], 10) || 0;
      return s * 7 + d;
    }

    Object.keys(grupos).forEach(k => {
      grupos[k].sort((a, b) => totalDias(b.igTexto) - totalDias(a.igTexto));
    });

    const hoje = new Date();
    const hojeStr = hoje.toISOString().slice(0,10).split("-").reverse().join("/");

    let htmlRel = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rio Geral de Gestantes</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    margin: 20px;
    color: #111827;
  }
  h1 {
    margin: 0 0 4px;
    font-size: 20px;
  }
  h2 {
    margin: 18px 0 4px;
    font-size: 16px;
  }
  .subtitulo {
    font-size: 12px;
    color: #4b5563;
    margin-bottom: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-bottom: 10px;
  }
  th, td {
    border: 1px solid #e5e7eb;
    padding: 4px 6px;
    vertical-align: top;
  }
  th {
    background: #f3f4f6;
    font-weight: 600;
  }
  .grupo-vazio {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 8px;
  }
</style>
</head>
<body>

<h1>Relat√≥rio geral de gestantes</h1>
<div class="subtitulo">Data: ${hojeStr} ‚Äì IG calculada para a data de hoje.</div>
`;

    function montarTabela(titulo, listaGrupo) {
      if (!listaGrupo.length) {
        htmlRel += `<h2>${titulo}</h2><div class="grupo-vazio">Nenhuma gestante neste grupo.</div>`;
        return;
      }
      htmlRel += `<h2>${titulo} (${listaGrupo.length})</h2>`;
      htmlRel += `
<table>
  <thead>
    <tr>
      <th>Nome / UBS</th>
      <th>IG hoje / DPP</th>
      <th>DUM / 1¬™ US</th>
      <th>Micro√°rea / ACS</th>
      <th>Testes r√°pidos / Condi√ß√µes / Alergias</th>
      <th>Vacinas / Odonto</th>
      <th>Consultas</th>
    </tr>
  </thead>
  <tbody>
`;
      listaGrupo.forEach(g => {
        const dppBr = g.dpp && g.dpp !== "‚Äî"
          ? g.dpp.split("-").reverse().join("/")
          : "‚Äî";
        const dumBr = g.dum ? g.dum.split("-").reverse().join("/") : "";
        const usBr = g.usData ? g.usData.split("-").reverse().join("/") : "";
        const usTxt = g.usData
          ? (usBr + (g.usSemanas ? ` (${g.usSemanas}s${g.usDias ? "+"+g.usDias+"d" : ""})` : ""))
          : "‚Äî";

        const consultasTxt = [
          g.consultaUltima ? ("√ölt.: " + g.consultaUltima) : "",
          g.consultaProxima ? ("Pr√≥x.: " + g.consultaProxima) : ""
        ].filter(Boolean).join("<br>");

        const testesTxt = resumoTestesGeral(g);

        htmlRel += `
    <tr>
      <td><strong>${g.nome}</strong><br>${g.ubs || ""}</td>
      <td>${g.igTexto}<br>DPP: ${dppBr}</td>
      <td>DUM: ${dumBr || "‚Äî"}<br>US: ${usTxt}</td>
      <td>${g.microarea || ""}<br>${g.acs || ""}</td>
      <td>${testesTxt ? testesTxt + "<br>" : ""}${g.condicoes || ""}<br><em>${g.alergias || ""}</em></td>
      <td>${g.vacinas || ""}<br>${g.odonto || ""}</td>
      <td>${consultasTxt || "‚Äî"}</td>
    </tr>
`;
      });

      htmlRel += `
  </tbody>
</table>
`;
    }

    montarTabela("Alto risco", grupos.alto);
    montarTabela("Risco intermedi√°rio", grupos.intermediario);
    montarTabela("Risco habitual", grupos.habitual);
    if (grupos.outro.length) {
      montarTabela("Sem risco definido / outro", grupos.outro);
    }

    htmlRel += `
<p style="margin-top:16px; font-size:11px; color:#6b7280; text-align:center;">
  Desenvolvido por Dra. Fernanda Schwartz.
</p>
</body>
</html>
`;

    const novaJanela = window.open("", "_blank");
    if (!novaJanela) {
      alert("Bloqueio de pop-up: permita pop-ups para visualizar o relat√≥rio.");
      return;
    }
    novaJanela.document.open();
    novaJanela.document.write(htmlRel);
    novaJanela.document.close();
  }

  function renderizarTabela() {
    const corpo = document.getElementById("tabela-gestantes");
    corpo.innerHTML = "";
    const lista = carregarGestantes();
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const hojeNum = hoje.getTime();

    lista.forEach(g => { g.ig = calcularIG(g.dum, g.usData, g.usSemanas, g.usDias); });

    lista.sort((a,b) => {
      const aProx = a.consultaProxima ? new Date(a.consultaProxima).getTime() : Infinity;
      const bProx = b.consultaProxima ? new Date(b.consultaProxima).getTime() : Infinity;
      const aAtraso = (aProx < hojeNum) ? 1 : 0;
      const bAtraso = (bProx < hojeNum) ? 1 : 0;
      if (aAtraso !== bAtraso) return bAtraso - aAtraso;

      const prioridadeRisco = { "alto": 3, "intermediario": 2, "baixo": 1, "": 0, null: 0 };
      const rA = prioridadeRisco[a.risco] || 0;
      const rB = prioridadeRisco[b.risco] || 0;
      if (rA !== rB) return rB - rA;

      const igA = a.ig ? a.ig.total : -1;
      const igB = b.ig ? b.ig.total : -1;
      return igB - igA;
    });

    lista.forEach(g => {
      const ig = g.ig;
      const dpp = g.dpp || estimarDPP(g.dum, g.usData, g.usSemanas, g.usDias);
      const risco = g.risco || "";
      const classeLinha = risco ? "row-" + risco : "";

      const proxNum = g.consultaProxima ? new Date(g.consultaProxima).getTime() : Infinity;
      const hoje = new Date();
      hoje.setHours(0,0,0,0);
      const atrasada = proxNum < hoje.getTime();

      if (filtroAtual === "atraso" && !atrasada) return;
      if (filtroAtual === "risco" && !(risco === "alto" || risco === "intermediario")) return;

      let textoIG = "‚Äî";
      if (ig) textoIG = `${ig.semanas}s ${ig.dias}d (${ig.metodo})`;

      const consultaProximaTxt = g.consultaProxima || "";
      let textoConsulta = "";
      if (g.consultaUltima) textoConsulta += "√öltima: " + g.consultaUltima + "<br>";
      if (consultaProximaTxt) {
        const dataProx = new Date(consultaProximaTxt);
        dataProx.setHours(0,0,0,0);
        if (dataProx < hoje) {
          textoConsulta += `<span class="badge badge-warn">Pr√≥xima (atrasada): ${consultaProximaTxt}</span>`;
        } else {
          textoConsulta += `Pr√≥xima: ${consultaProximaTxt}`;
        }
      }

      const alertas = gerarAlertasExames(ig, g.ex1, g.ex2, g.ex3, g.swab);

      let riskLabel = "N√£o informado";
      if (risco === "baixo") riskLabel = "Risco habitual";
      if (risco === "intermediario") riskLabel = "Risco intermedi√°rio";
      if (risco === "alto") riskLabel = "Alto risco";

      const pillClass = risco ? `pill-risk ${risco}` : "pill-risk";
      const idadeCalc = g.dataNasc ? calcularIdade(g.dataNasc) : "";

      const linha = document.createElement("tr");
      linha.className = classeLinha;

      linha.innerHTML = `
        <td>
          <strong>ü§∞ ${g.nome || "Sem nome"}</strong><br>
          <span class="small">
            ${g.dataNasc ? "Nasc.: " + g.dataNasc + (idadeCalc ? " ("+idadeCalc+" anos)" : "") + "<br>" : ""}
            ${g.idade ? "Idade (campo): " + g.idade + " anos<br>" : ""}
            ${g.ubs || ""} ${g.microarea ? " ¬∑ Micro√°rea " + g.microarea : ""} ${g.acs ? " ¬∑ ACS " + g.acs : ""}
          </span>
        </td>
        <td>
          ${textoIG}<br>
          <span class="small">
            ${g.dum ? "DUM: " + g.dum + "<br>" : ""}
            ${g.usData ? "1¬™ US: " + g.usData + " (" + (g.usSemanas || "0") + "s" + (g.usDias ? " " + g.usDias + "d" : "") + ")<br>" : ""}
            DPP: ${dpp || "‚Äî"}
          </span>
        </td>
        <td>
          <span class="${pillClass}">
            ${riskLabel}
          </span>
        </td>
        <td>
          ${badgeExame(g.ex1, "1¬∫ tri")}<br>
          ${badgeExame(g.ex2, "2¬∫ tri / TTOG")}<br>
          ${badgeExame(g.ex3, "3¬∫ tri")}<br>
          ${badgeExame(g.swab, "Swab")}<br>
          ${badgeOkPend(g.vacinas, "Vacinas em dia", "Vacinas pendentes")}<br>
          ${badgeOkPend(g.odonto, "Odonto OK", "Odonto pendente")}<br>
          ${badgeTesteRapido(g.hivStatus, "HIV", g.hivObs)}<br>
          ${badgeTesteRapido(g.sifilisStatus, "S√≠filis", g.sifilisObs)}<br>
          ${badgeTesteRapido(g.hbvStatus, "Hepatite B", g.hbvObs)}<br>
          ${badgeTesteRapido(g.hcvStatus, "Hepatite C", g.hcvObs)}
        </td>
        <td>
          ${textoConsulta || "‚Äî"}
        </td>
        <td>
          ${alertas}
        </td>
        <td>
          <span class="small">
            ${g.condicoes ? "<b>Condi√ß√µes:</b> " + g.condicoes.replace(/\\n/g,"<br>") + "<br>" : ""}
            ${g.alergias ? "<b>Alergias:</b> " + g.alergias.replace(/\\n/g,"<br>") + "<br>" : ""}
            ${g.justificativa ? "<b>Justificativa:</b> " + g.justificativa.replace(/\\n/g,"<br>") : ""}
            ${!g.condicoes && !g.alergias && !g.justificativa ? "‚Äî" : ""}
          </span>
        </td>
        <td>
          <button class="btn-outline btn-small" type="button" onclick='editarGestante(${JSON.stringify(g.id)})'>‚úèÔ∏è Editar</button>
          <button class="btn-outline btn-small" type="button" onclick='removerGestante(${JSON.stringify(g.id)})'>üóëÔ∏è Remover</button>
          <button class="btn-outline btn-small" type="button" onclick='abrirResumoPDF(${JSON.stringify(g.id)})'>üìÑ PDF</button>
        </td>
      `;
      corpo.appendChild(linha);
    });

    atualizarBotoesFiltro();
  }

  function editarGestante(id) {
    const lista = carregarGestantes();
    const g = lista.find(x => x.id === id);
    if (!g) return;
    preencherFormulario(g);
  }

  document.getElementById("form-gestante").addEventListener("submit", function(e) {
    e.preventDefault();
    const lista = carregarGestantes();
    const idExistente = document.getElementById("id").value;
    const isNovo = !idExistente;

    const nome = document.getElementById("nome").value.trim();
    if (!nome) {
      alert("Informe o nome da gestante.");
      return;
    }

    const dum = document.getElementById("dum").value;
    const usData = document.getElementById("usData").value;
    const usSemanas = document.getElementById("usSemanas").value;
    const usDias = document.getElementById("usDias").value;
    const risco = document.getElementById("risco").value;
    const consultaUltima = document.getElementById("consultaUltima").value;
    let consultaProxima = document.getElementById("consultaProxima").value;

    const ig = calcularIG(dum, usData, usSemanas, usDias);
    const dpp = estimarDPP(dum, usData, usSemanas, usDias);

    if (!consultaProxima && ig) {
      consultaProxima = sugerirProximaConsulta(ig, risco, consultaUltima);
    }

    const gestante = {
      id: isNovo ? Date.now() : Number(idExistente),
      nome,
      dataNasc: document.getElementById("dataNasc").value,
      idade: document.getElementById("idade").value,
      ubs: document.getElementById("ubs").value,
      microarea: document.getElementById("microarea").value,
      acs: document.getElementById("acs").value,
      risco,
      dum,
      usData,
      usSemanas,
      usDias,
      consultaUltima,
      consultaProxima,
      dpp,
      swab: document.getElementById("swab").value,
      ex1: document.getElementById("ex1").value,
      ex2: document.getElementById("ex2").value,
      ex3: document.getElementById("ex3").value,
      vacinas: document.getElementById("vacinas").value,
      odonto: document.getElementById("odonto").value,
      condicoes: document.getElementById("condicoes").value.trim(),
      alergias: document.getElementById("alergias").value.trim(),
      justificativa: document.getElementById("justificativa").value.trim(),
      hivStatus: document.getElementById("hivStatus").value,
      hivObs: document.getElementById("hivObs").value.trim(),
      sifilisStatus: document.getElementById("sifilisStatus").value,
      sifilisObs: document.getElementById("sifilisObs").value.trim(),
      hbvStatus: document.getElementById("hbvStatus").value,
      hbvObs: document.getElementById("hbvObs").value.trim(),
      hcvStatus: document.getElementById("hcvStatus").value,
      hcvObs: document.getElementById("hcvObs").value.trim()
    };

    const listaAtual = carregarGestantes();
    if (isNovo) {
      listaAtual.push(gestante);
    } else {
      const idx = listaAtual.findIndex(g => g.id === gestante.id);
      if (idx >= 0) listaAtual[idx] = gestante;
    }

    salvarGestantes(listaAtual);
    renderizarTabela();
    document.getElementById("dpp").value = dpp || "";
  });

  function exportarCSV() {
    const lista = carregarGestantes();
    if (!lista.length) {
      alert("N√£o h√° gestantes cadastradas.");
      return;
    }

    const headers = [
      "Nome","DataNasc","IdadeCampo","UBS","Microarea","ACS","Risco",
      "DUM","Data1aUS","IGUS_sem","IGUS_dias",
      "UltimaConsulta","ProximaConsulta","DPP",
      "Exames1Tri","Exames2Tri_TTOG","Exames3Tri",
      "Swab","Vacinas","Odonto",
      "HIV_status","HIV_obs",
      "Sifilis_status","Sifilis_obs",
      "HepB_status","HepB_obs",
      "HepC_status","HepC_obs",
      "CondicoesSaude","Alergias","Justificativa"
    ];

    const linhas = [headers.join(";")];

    lista.forEach(g => {
      const linha = [
        g.nome || "",
        g.dataNasc || "",
        g.idade || "",
        g.ubs || "",
        g.microarea || "",
        g.acs || "",
        g.risco || "",
        g.dum || "",
        g.usData || "",
        g.usSemanas || "",
        g.usDias || "",
        g.consultaUltima || "",
        g.consultaProxima || "",
        g.dpp || "",
        g.ex1 || "",
        g.ex2 || "",
        g.ex3 || "",
        g.swab || "",
        g.vacinas || "",
        g.odonto || "",
        g.hivStatus || "",
        (g.hivObs || "").replace(/[\r\n]+/g," "),
        g.sifilisStatus || "",
        (g.sifilisObs || "").replace(/[\r\n]+/g," "),
        g.hbvStatus || "",
        (g.hbvObs || "").replace(/[\r\n]+/g," "),
        g.hcvStatus || "",
        (g.hcvObs || "").replace(/[\r\n]+/g," "),
        (g.condicoes || "").replace(/[\r\n]+/g," "),
        (g.alergias || "").replace(/[\r\n]+/g," "),
        (g.justificativa || "").replace(/[\r\n]+/g," ")
      ];
      linhas.push(linha.join(";"));
    });

    const blob = new Blob([linhas.join("\n")], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gestantes-pre-natal-dra-schwartz.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportarBackupJSON() {
    const lista = carregarGestantes();
    const blob = new Blob([JSON.stringify(lista, null, 2)], {type: "application/json;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-pre-natal-dra-schwartz.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importarBackupJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const dados = JSON.parse(e.target.result);
        if (!Array.isArray(dados)) throw new Error("Formato inv√°lido");
        salvarGestantes(dados);
        renderizarTabela();
        alert("Backup importado com sucesso!");
      } catch (err) {
        alert("Erro ao importar backup. Verifique o arquivo.");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function setFiltro(tipo) {
    filtroAtual = tipo;
    renderizarTabela();
  }

  function atualizarBotoesFiltro() {
    const map = { "todas": "f-todas", "atraso": "f-atraso", "risco": "f-risco" };
    Object.keys(map).forEach(k => {
      const btn = document.getElementById(map[k]);
      if (!btn) return;
      if (k === filtroAtual) btn.classList.add("btn-filter-active");
      else btn.classList.remove("btn-filter-active");
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    renderizarTabela();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const auth = window._auth;
    const fns = window._authFns || {};
    const onAuthStateChanged = fns.onAuthStateChanged;
    const signInWithEmailAndPassword = fns.signInWithEmailAndPassword;
    const signOut = fns.signOut;

    const loginContainer = document.getElementById("login-container");
    const headerElm = document.querySelector("header");
    const appContainer = document.querySelector(".container");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const loginButton = document.getElementById("login-submit");
    const logoutBtn = document.getElementById("logout-btn");

    function showLoggedIn() {
      if (loginContainer) loginContainer.style.display = "none";
      if (headerElm) headerElm.classList.remove("app-auth-hidden");
      if (appContainer) appContainer.classList.remove("app-auth-hidden");
      if (logoutBtn) logoutBtn.style.display = "inline-flex";
    }

    function showLoggedOut() {
      if (loginContainer) loginContainer.style.display = "block";
      if (headerElm) headerElm.classList.add("app-auth-hidden");
      if (appContainer) appContainer.classList.add("app-auth-hidden");
      if (logoutBtn) logoutBtn.style.display = "none";
      if (loginButton) {
        loginButton.disabled = false;
        loginButton.textContent = "Entrar";
      }
    }

    if (loginForm && signInWithEmailAndPassword && auth) {
      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (loginError) {
          loginError.style.display = "none";
          loginError.textContent = "";
        }
        if (loginButton) {
          loginButton.disabled = true;
          loginButton.textContent = "Entrando...";
        }

        const email = document.getElementById("login-email").value.trim();
        const senha = document.getElementById("login-password").value;

        try {
          await signInWithEmailAndPassword(auth, email, senha);
        } catch (err) {
          console.error(err);
          if (loginError) {
            loginError.textContent = "E-mail ou senha inv√°lidos.";
            loginError.style.display = "block";
          }
          if (loginButton) {
            loginButton.disabled = false;
            loginButton.textContent = "Entrar";
          }
        }
      });
    }

    if (logoutBtn && signOut && auth) {
      logoutBtn.addEventListener("click", async function () {
        try {
          await signOut(auth);
        } catch (err) {
          console.error(err);
        }
      });
    }

    if (onAuthStateChanged && auth) {
      onAuthStateChanged(auth, function (user) {
        if (user) {
          showLoggedIn();
        } else {
          showLoggedOut();
        }
      });
    } else {
      // fallback: se Firebase n√£o carregar, n√£o travar o uso do app
      if (headerElm) headerElm.classList.remove("app-auth-hidden");
      if (appContainer) appContainer.classList.remove("app-auth-hidden");
      if (loginContainer) loginContainer.style.display = "none";
    }
  });
</script>

</body>
</html>
